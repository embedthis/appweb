/*
    ext.tst - Test cache matching by extension.
 */


import {print, thas, ttrue, tget} from 'testme'
import {Http} from 'ejscript'

const HTTP = tget('TM_HTTP') || "127.0.0.1:4100"
let http: Http = new Http

/*
    Fetch twice and see if caching is working
 */
async function cached(uri, expected): Promise<Boolean> {
    http.get(HTTP + uri)
    await http.finalize()
    ttrue(http.status == 200)
    let resp = deserialize(http.response)
    let first = resp.number

    http.get(HTTP + uri)
    await http.finalize()
    ttrue(http.status == 200)
    resp = deserialize(http.response)
    if (expected != (resp.number == first)) {
        console.log("\nFirst number:  " + first)
        console.log("\nSecond number: " + resp.number)
        dump(http.response)
    }
    http.close()
    return (resp.number == first)
}

//  The esp request should be cached
if (thas('ME_ESP')) {
    ttrue(await cached("/ext/cache.esp", true))
}
